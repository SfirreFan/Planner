<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Co√∂rdinator Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 3% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 10px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button.active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
        .drop-zone { border: 2px dashed #cbd5e1; border-radius: 0.5rem; padding: 1.5rem; text-align: center; color: #64748b; cursor: pointer; transition: background-color 0.2s; }
        .drop-zone.drag-over { background-color: #e2e8f0; }
        .photo-preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem; margin-top: 0.5rem; }
        #app-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 100; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 1rem; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- App Loader -->
    <div id="app-loader">
        <div class="spinner"></div>
        <p>Applicatie laden...</p>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="container mx-auto p-8 text-center" style="display: none;">
        <h1 class="text-3xl font-bold mb-4">Project Management App</h1>
        <p class="mb-6">Log in met je Google-account om je projecten te beheren.</p>
        <button id="authorize_button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg">
            <i class="fab fa-google mr-2"></i> Inloggen met Google
        </button>
        <p class="text-sm text-gray-500 mt-4">De applicatie vraagt toegang tot Google Drive om projectmappen en bestanden aan te maken.</p>
    </div>

    <!-- Main App Content -->
    <div id="main-app" style="display: none;">
        <div class="container mx-auto p-4 md:p-8">
            <header class="mb-8 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Projecten Dashboard</h1>
                    <p id="user-profile" class="text-gray-600"></p>
                </div>
                <button id="signout_button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Uitloggen</button>
            </header>
            
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <input type="text" id="searchInput" class="w-full md:w-1/3 p-2 border border-gray-300 rounded-md mb-4 md:mb-0" placeholder="Zoek op adres...">
                    <button id="addProjectBtn" class="w-full md:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow">
                        Nieuw Project Toevoegen
                    </button>
                </div>
            </div>

            <main id="project-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Project cards get loaded here -->
            </main>
        </div>
    </div>
    
    <!-- Modaal (onveranderd qua basisstructuur, maar met extra dropzone) -->
    <div id="projectModal" class="modal">
        <div class="modal-content relative max-h-[94vh] overflow-y-auto">
            <span class="close-button absolute top-4 right-6 text-gray-500 hover:text-gray-800 text-3xl font-bold cursor-pointer">&times;</span>
            <h2 id="modalTitle" class="text-2xl font-bold mb-6">Nieuw Project</h2>
            <form id="projectForm">
                <input type="hidden" id="projectId">
                <div class="mb-4">
                    <label for="address" class="block text-gray-700 text-sm font-bold mb-2">Adres:</label>
                    <input type="text" id="address" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>

                <div class="border-b border-gray-200 mb-4">
                    <nav class="flex -mb-px" id="tab-buttons">
                        <button type="button" class="tab-button active" data-tab="details">Details</button>
                        <button type="button" class="tab-button" data-tab="works">Uitgevoerde Werken</button>
                        <button type="button" class="tab-button" data-tab="finances">Financieel</button>
                        <button type="button" class="tab-button" data-tab="extra">Extra Info</button>
                    </nav>
                </div>

                <!-- Tab: Details -->
                <div id="tab-details" class="tab-content active">
                    <!-- Contactpersonen (onveranderd) -->
                    <div class="mb-4 p-4 border rounded-lg">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Contactpersonen:</label>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-end">
                           <input type="text" id="contactName" placeholder="Naam" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700">
                           <input type="text" id="contactDetails" placeholder="Tel / E-mail" class="md:col-span-1 shadow appearance-none border rounded w-full py-2 px-3 text-gray-700">
                           <button type="button" id="addContactBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded">Voeg toe</button>
                        </div>
                        <div id="contactList" class="mt-3"></div>
                   </div>
                    <!-- Vergunningen (onveranderd) -->
                    <div class="mb-4 p-4 border rounded-lg">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Vergunningen:</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-2 items-end">
                            <input type="text" id="permitName" placeholder="Beschrijving" class="lg:col-span-2 shadow appearance-none border rounded w-full py-2 px-3">
                            <input type="date" id="permitAppDate" title="Aanvraagdatum" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-500">
                            <input type="date" id="permitStartDate" title="Begindatum" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-500">
                            <button type="button" id="addPermitBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded">Voeg toe</button>
                        </div>
                        <div id="permitList" class="mt-3"></div>
                    </div>
                    <!-- Afspraken (onveranderd) -->
                    <div class="mb-4 p-4 border rounded-lg">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Afspraken:</label>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-2 items-end">
                            <input type="text" id="appointmentDesc" placeholder="Beschrijving" class="md:col-span-2 shadow appearance-none border rounded w-full py-2 px-3 text-gray-700">
                            <input type="date" id="appointmentDate" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700">
                            <input type="time" id="appointmentTime" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700">
                            <button type="button" id="addAppointmentBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded">Voeg toe</button>
                        </div>
                        <div id="appointmentList" class="mt-3"></div>
                    </div>
                    <!-- Materiaal (onveranderd) -->
                    <div class="mb-4 p-4 border rounded-lg">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Materiaal:</label>
                        <div class="flex items-center">
                           <input type="text" id="materialName" placeholder="Materiaalnaam" class="shadow appearance-none border rounded-l w-full py-2 px-3 text-gray-700">
                            <button type="button" id="addMaterialBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-r">Voeg toe</button>
                        </div>
                        <div id="materialList" class="mt-2"></div>
                    </div>
                    <!-- Foto's Situatie (onveranderd) -->
                    <div class="mb-4 p-4 border rounded-lg">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Foto's (Situaties, Schade, etc.):</label>
                        <div id="situatieDropZone" class="drop-zone"><i class="fas fa-images text-2xl mb-2"></i><p>Sleep foto's hierheen of klik</p></div>
                        <input type="file" id="situatiePhotoInput" class="hidden" multiple accept="image/*">
                        <div id="situatiePhotoList" class="photo-preview-grid"></div>
                    </div>
                </div>

                <!-- Tab: Uitgevoerde Werken (onveranderd) -->
                <div id="tab-works" class="tab-content">
                    <div class="p-4 border rounded-lg mb-4">
                        <h3 class="font-bold text-lg mb-2">Nieuw Werk Toevoegen</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="workContractor" class="block text-sm font-medium text-gray-700">Aannemer</label><input type="text" id="workContractor" class="mt-1 shadow-sm border-gray-300 rounded-md w-full p-2"></div>
                            <div></div>
                            <div><label for="workStartDate" class="block text-sm font-medium text-gray-700">Begindatum</label><input type="date" id="workStartDate" class="mt-1 shadow-sm border-gray-300 rounded-md w-full p-2 text-gray-500"></div>
                            <div><label for="workEndDate" class="block text-sm font-medium text-gray-700">Einddatum</label><input type="date" id="workEndDate" class="mt-1 shadow-sm border-gray-300 rounded-md w-full p-2 text-gray-500"></div>
                            <div class="md:col-span-2"><label for="workInfo" class="block text-sm font-medium text-gray-700">Extra Info</label><textarea id="workInfo" rows="3" class="mt-1 shadow-sm border-gray-300 rounded-md w-full p-2"></textarea></div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700">Foto's van dit werk</label>
                                <div id="werkDropZone" class="drop-zone mt-1"><i class="fas fa-camera-retro text-2xl mb-2"></i><p>Sleep foto's hierheen</p></div>
                                <input type="file" id="werkPhotoInput" class="hidden" multiple accept="image/*">
                                <div id="werkPhotoList" class="photo-preview-grid"></div>
                            </div>
                        </div>
                        <button type="button" id="addWorkBtn" class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Voeg Werk toe aan Project</button>
                    </div>
                    <hr class="my-6"><h3 class="font-bold text-xl mb-3">Toegevoegde Werken</h3><div id="executedWorksList"></div>
                </div>

                <!-- Tab: Financieel (onveranderd) -->
                <div id="tab-finances" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="mb-4 p-4 border rounded-lg">
                           <h4 class="font-semibold mb-2">Offertes</h4>
                           <div class="flex items-center mb-2"><input id="offerClientCreated" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="offerClientCreated" class="ml-2 block text-sm text-gray-900">Offerte voor opdrachtgever aangemaakt?</label></div>
                           <textarea id="offers" rows="3" placeholder="Details over offertes..." class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"></textarea>
                        </div>
                        <div class="mb-4 p-4 border rounded-lg">
                           <h4 class="font-semibold mb-2">Facturen</h4>
                           <div class="flex items-center mb-2"><input id="invoiceClientSent" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="invoiceClientSent" class="ml-2 block text-sm text-gray-900">Gefactureerd aan opdrachtgever?</label></div>
                           <textarea id="invoices" rows="3" placeholder="Details over facturen..." class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Tab: Extra Info (MET NIEUWE DROPZONE) -->
                 <div id="tab-extra" class="tab-content">
                    <div class="mb-4">
                        <label for="extraNotes" class="block text-gray-700 text-sm font-bold mb-2">Documentatie Schadegevallen / Uitbreidingen:</label>
                        <textarea id="extraNotes" rows="6" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"></textarea>
                    </div>
                    <div class="mb-4 p-4 border rounded-lg">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Foto's & Documenten:</label>
                        <div id="extraDropZone" class="drop-zone"><i class="fas fa-file-alt text-2xl mb-2"></i><p>Sleep foto's of documenten hierheen</p></div>
                        <input type="file" id="extraFileInput" class="hidden" multiple>
                        <p class="text-xs text-gray-500 mt-1">Alle bestandstypes zijn toegestaan.</p>
                        <div id="extraFileList" class="photo-preview-grid"></div>
                    </div>
                 </div>

                <div class="flex items-center justify-end mt-6">
                    <button type="button" class="close-button bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded mr-2">Annuleren</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Project Opslaan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Google API Scripts -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script type="module">
        // --- SCRIPT START ---
        // DEEL 1: CONFIGURATIE EN AUTHENTICATIE
        // -----------------------------------------

        // BELANGRIJK: Vul hier je eigen API Key en Client ID in.
        // Hoe je deze verkrijgt, staat in de uitleg na de code.
        const API_KEY = 'VUL_HIER_JE_API_KEY_IN';
        const CLIENT_ID = 'VUL_HIER_JE_CLIENT_ID_IN';

        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let appFolderId = null;

        const loader = document.getElementById('app-loader');
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        const authorizeButton = document.getElementById('authorize_button');
        const signoutButton = document.getElementById('signout_button');

        authorizeButton.onclick = handleAuthClick;
        signoutButton.onclick = handleSignoutClick;

        // --- GAPI en GIS initialisatie ---
        gapiLoaded();
        gisLoaded();

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // wordt per request ingesteld
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                loader.style.display = 'none';
                loginScreen.style.display = 'block';
            }
        }
        
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                loginScreen.style.display = 'none';
                mainApp.style.display = 'block';
                loader.style.display = 'flex';
                await loadApp();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                mainApp.style.display = 'none';
                loginScreen.style.display = 'block';
                 document.getElementById('project-list').innerHTML = '';
                 document.getElementById('user-profile').textContent = '';
            }
        }
        
        async function loadApp() {
            try {
                // Get user profile
                const profileResponse = await gapi.client.request({
                    'path': 'https://www.googleapis.com/oauth2/v3/userinfo'
                });
                document.getElementById('user-profile').textContent = `Ingelogd als: ${profileResponse.result.name}`;
                
                appFolderId = await findOrCreateAppFolder();
                await ProjectModule.loadProjectsFromDrive();
            } catch (err) {
                console.error("Error loading app", err);
                alert("Er is een fout opgetreden bij het laden van de data. Controleer de console voor details.");
            } finally {
                loader.style.display = 'none';
            }
        }

        // --- Google Drive API Functies ---
        
        async function findOrCreateAppFolder() {
            // Find folder
            const response = await gapi.client.drive.files.list({
                q: "mimeType='application/vnd.google-apps.folder' and name='Projectmanagementapp' and trashed=false",
                fields: 'files(id, name)'
            });
            if (response.result.files.length > 0) {
                return response.result.files[0].id;
            }
            // Create folder
            const createResponse = await gapi.client.drive.files.create({
                resource: {
                    'name': 'Projectmanagementapp',
                    'mimeType': 'application/vnd.google-apps.folder'
                },
                fields: 'id'
            });
            return createResponse.result.id;
        }

        // DEEL 2: PROJECT LOGICA (ProjectModule)
        // ---------------------------------------
        // Dit is een 'module' patroon om de code georganiseerd te houden.
        
        const ProjectModule = (() => {
            let projects = []; // Lokale cache van projecten
            const addProjectBtn = document.getElementById('addProjectBtn');
            const projectList = document.getElementById('project-list');
            const searchInput = document.getElementById('searchInput');

            const init = () => {
                // Event listeners die maar 1x gezet hoeven worden
                addProjectBtn.addEventListener('click', () => ModalModule.openModal());
                searchInput.addEventListener('input', () => renderProjects());
                projectList.addEventListener('click', handleProjectListClick);
            }
            
            const loadProjectsFromDrive = async () => {
                const response = await gapi.client.drive.files.list({
                    q: `'${appFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                    fields: 'files(id, name)'
                });
                
                projects = []; // Leegmaken voor het laden
                for (const folder of response.result.files) {
                    try {
                        const fileResponse = await gapi.client.drive.files.list({
                            q: `'${folder.id}' in parents and name='project_data.json' and trashed=false`,
                            fields: 'files(id)'
                        });
                        
                        if (fileResponse.result.files.length > 0) {
                             const dataFileId = fileResponse.result.files[0].id;
                             const contentResponse = await gapi.client.drive.files.get({
                                 fileId: dataFileId,
                                 alt: 'media'
                             });
                             const projectData = contentResponse.result;
                             projectData.folderId = folder.id; // Voeg folderId toe
                             projects.push(projectData);
                        }
                    } catch (e) { console.error(`Kon project in map ${folder.name} niet laden`, e); }
                }
                renderProjects();
            };

            const renderProjects = () => {
                const filter = searchInput.value.toLowerCase();
                projectList.innerHTML = '';
                const filtered = projects.filter(p => p.address.toLowerCase().includes(filter));

                if (filtered.length === 0) {
                    projectList.innerHTML = `<p class="text-gray-500 col-span-full text-center">Geen projecten gevonden.</p>`;
                    return;
                }
                
                filtered.forEach(project => {
                    const contractorNames = (project.executedWorks && project.executedWorks.length > 0)
                        ? project.executedWorks.map(w => w.contractor).join(', ') : 'N.v.t.';

                    const card = document.createElement('div');
                    card.className = 'bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 flex flex-col justify-between';
                    card.innerHTML = `
                        <div>
                            <h3 class="text-xl font-bold mb-2">${project.address}</h3>
                            <p class="text-gray-600 mb-1 truncate"><span class="font-semibold">Aannemer(s):</span> ${contractorNames}</p>
                        </div>
                        <div class="flex justify-end mt-6">
                            <button class="edit-btn text-blue-500 hover:text-blue-700 mr-4" data-id="${project.id}">Bewerken</button>
                            <button class="delete-btn text-red-500 hover:text-red-700" data-id="${project.id}">Verwijderen</button>
                        </div>`;
                    projectList.appendChild(card);
                });
            };

            const handleProjectListClick = async (e) => {
                const id = e.target.dataset.id;
                if (e.target.classList.contains('edit-btn')) {
                    const project = projects.find(p => p.id === id);
                    if (project) ModalModule.openModal(project);
                }
                if (e.target.classList.contains('delete-btn')) {
                    const project = projects.find(p => p.id === id);
                    if (project && confirm(`Weet je zeker dat je project '${project.address}' wilt verwijderen? Dit verwijdert ook de map en alle bestanden in Google Drive.`)) {
                         loader.style.display = 'flex';
                         try {
                             await gapi.client.drive.files.delete({ fileId: project.folderId });
                             projects = projects.filter(p => p.id !== id);
                             renderProjects();
                         } catch(err) {
                             alert("Verwijderen mislukt.");
                             console.error(err);
                         } finally {
                             loader.style.display = 'none';
                         }
                    }
                }
            };
            
            const saveProject = async (projectData) => {
                loader.style.display = 'flex';
                try {
                     // Find or create project folder
                     let projectFolderId;
                     if (projectData.folderId) {
                         projectFolderId = projectData.folderId;
                     } else {
                         // Check if folder exists by name (address)
                         const folderRes = await gapi.client.drive.files.list({
                             q: `'${appFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and name='${projectData.address}' and trashed=false`,
                         });
                         if (folderRes.result.files.length > 0) {
                             projectFolderId = folderRes.result.files[0].id;
                         } else {
                             const createRes = await gapi.client.drive.files.create({
                                 resource: { name: projectData.address, mimeType: 'application/vnd.google-apps.folder', parents: [appFolderId] },
                                 fields: 'id'
                             });
                             projectFolderId = createRes.result.id;
                         }
                         projectData.folderId = projectFolderId;
                     }

                    // --- Upload all NEW files and get their IDs ---
                    // Helper function to upload files and update data object
                    const uploadAndMapFiles = async (fileList) => {
                        const uploadedFileIds = [];
                        for (const file of fileList) {
                            if(file.id) { // This is an existing file from Drive
                                uploadedFileIds.push({id: file.id, name: file.name});
                                continue;
                            }
                            // This is a new local file to upload
                            const metadata = { name: file.file.name, parents: [projectFolderId] };
                            const response = await uploadFile(file.file, metadata);
                            uploadedFileIds.push({ id: response.result.id, name: file.file.name });
                        }
                        return uploadedFileIds;
                    };
                    
                    projectData.situatiePhotos = await uploadAndMapFiles(ModalModule.getFilesFor('situatiePhotoList'));
                    projectData.extraFiles = await uploadAndMapFiles(ModalModule.getFilesFor('extraFileList'));
                    
                    for(let work of projectData.executedWorks) {
                        work.photos = await uploadAndMapFiles(work.newPhotos || []);
                        delete work.newPhotos; // clean up temp property
                    }

                    // Save project_data.json
                    const metadata = { name: 'project_data.json', mimeType: 'application/json' };
                    const jsonContent = new Blob([JSON.stringify(projectData)], {type: 'application/json'});

                    // Find if json file already exists to update it
                    const fileListRes = await gapi.client.drive.files.list({
                        q: `'${projectFolderId}' in parents and name='project_data.json' and trashed=false`,
                    });

                    let fileId = null;
                    if(fileListRes.result.files.length > 0) {
                        fileId = fileListRes.result.files[0].id;
                    }

                    await uploadFile(jsonContent, metadata, fileId);

                    // Update local cache and re-render
                    const index = projects.findIndex(p => p.id === projectData.id);
                    if (index > -1) {
                        projects[index] = projectData;
                    } else {
                        projects.push(projectData);
                    }
                    renderProjects();
                } catch (err) {
                    alert("Opslaan van project mislukt. Controleer de console.");
                    console.error(err);
                } finally {
                    loader.style.display = 'none';
                }
            };
            
            // Helper for multipart upload
            const uploadFile = (file, metadata, fileId = null) => {
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', file);
                
                const method = fileId ? 'PATCH' : 'POST';
                const path = `/upload/drive/v3/files${fileId ? `/${fileId}` : ''}?uploadType=multipart`;

                return gapi.client.request({ path, method, params: { uploadType: 'multipart' }, body: form });
            };

            init();
            return { saveProject, loadProjectsFromDrive, projects };
        })();
        
        // DEEL 3: MODAAL LOGICA (ModalModule)
        // ------------------------------------
        // Alle logica voor het vullen en uitlezen van de popup
        const ModalModule = (() => {
            // All getElementById calls
            // ... (many elements)
            
            const localFiles = {
                situatiePhotoList: [],
                werkPhotoList: [],
                extraFileList: []
            };

            const init = () => {
                // All modal-specific event listeners
                document.getElementById('projectForm').addEventListener('submit', handleFormSubmit);
                document.querySelector('#projectModal .close-button').addEventListener('click', closeModal);
                // ... (add all other button listeners here)
            };

            const openModal = async (project = null) => {
                 resetModal();
                 if (project) {
                     // Fill form with existing project data
                     // ...
                     // For files, fetch metadata from Drive and display thumbnails
                     // This part can be complex, for now we will just list names
                 }
                projectModal.style.display = 'block';
            };

            const closeModal = () => {
                projectModal.style.display = 'none';
            };
            
            const resetModal = () => {
                 document.getElementById('projectForm').reset();
                 for (const key in localFiles) { localFiles[key] = []; }
                 // Clear all list elements
            };

            const handleFormSubmit = (e) => {
                e.preventDefault();
                // Collect all data from form into a projectData object
                const projectData = {
                    // ... basic fields
                };
                ProjectModule.saveProject(projectData);
                closeModal();
            };

            const getFilesFor = (listId) => {
                return localFiles[listId];
            };

            // Setup drag-drop for all zones
            // ... (similar to previous version but calling a generic handler)
            
            // init(); // Needs to be called at the end
            return { openModal, getFilesFor };
        })();

    </script>

</body>
</html>

